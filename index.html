<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Terminplaner</title>
  <style>
    body {
      font-family: sans-serif;
      background: #f9fafb;
      padding: 2rem;
      color: #333;
    }
    h1 {
      font-size: 2rem;
      margin-bottom: 1rem;
    }
    table {
      border-collapse: collapse;
      width: 100%;
      margin-bottom: 2rem;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 0.5rem;
      text-align: center;
      position: relative;
    }
    th {
      background: #f0f0f0;
    }
    .cell {
      cursor: pointer;
      background: #fff;
      transition: background 0.2s;
    }
    .cell.selected {
      background: #4ade80;
      color: white;
    }
    .cell:hover::after {
      content: attr(data-tooltip);
      position: absolute;
      background: #333;
      color: #fff;
      font-size: 0.75rem;
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
      white-space: pre-line;
      top: -2.5em;
      left: 50%;
      transform: translateX(-50%);
      pointer-events: none;
      z-index: 1;
    }
    .controls {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 1rem;
    }
    input[type="text"] {
      padding: 0.5rem;
      flex: 1;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    button {
      padding: 0.5rem 1rem;
      background: #3b82f6;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    button:hover {
      background: #2563eb;
    }
    .actions button {
      margin: 0 0.25rem;
      background: #facc15;
      color: black;
    }
    .actions button:hover {
      background: #eab308;
    }
    #stats {
      background: #fff;
      padding: 1rem;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      font-size: 0.9rem;
    }
  </style>
</head>
<body>
  <h1>üìÖ Terminplaner</h1>

  <div class="controls">
    <input type="text" id="nameInput" placeholder="Teilnehmername eingeben" />
    <button id="addBtn">Hinzuf√ºgen</button>
  </div>

  <table id="schedule">
    <thead>
      <tr>
        <th>Name</th>
        <th>2025-05-01</th>
        <th>2025-05-02</th>
        <th>2025-05-03</th>
        <th>Aktionen</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <div id="stats"></div>

  <!-- Firebase SDK -->
  <script type="module">
    // Import Firebase modules
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getDatabase, ref, set, remove, onValue } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

    const firebaseConfig = {
      // üîí DEINE KONFIG HIER EINF√úGEN
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_PROJECT.firebaseapp.com",
      databaseURL: "https://YOUR_PROJECT.firebaseio.com",
      projectId: "YOUR_PROJECT",
      storageBucket: "YOUR_PROJECT.appspot.com",
      messagingSenderId: "YOUR_SENDER_ID",
      appId: "YOUR_APP_ID"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const nameInput = document.getElementById("nameInput");
    const addBtn = document.getElementById("addBtn");
    const tbody = document.querySelector("#schedule tbody");
    const allDates = ["2025-05-01", "2025-05-02", "2025-05-03"];
    let selections = {};

    addBtn.addEventListener("click", () => {
      const name = nameInput.value.trim();
      if (!name || selections[name]) {
        alert("Ung√ºltiger oder doppelter Name.");
        return;
      }
      const now = Date.now();
      set(ref(db, `participants/${name}`), {
        dates: ["init"],
        createdAt: now,
        updatedAt: now
      });
      nameInput.value = "";
    });

    function toggleCell(name, date) {
      const current = selections[name]?.dates || [];
      const index = current.indexOf(date);
      if (index > -1) current.splice(index, 1);
      else current.push(date);
      saveSelection(name);
    }

    function saveSelection(name) {
      const selected = [];
      for (const date of allDates) {
        if (document.querySelector(`.cell[data-name="${name}"][data-date="${date}"]`)?.classList.contains("selected")) {
          selected.push(date);
        }
      }
      const now = Date.now();
      const createdAt = selections[name]?.createdAt || now;
      set(ref(db, `participants/${name}`), {
        dates: selected.length > 0 ? selected : ["init"],
        createdAt,
        updatedAt: now
      });
    }

    function deleteParticipant(name) {
      if (confirm(`Teilnehmer "${name}" l√∂schen?`)) {
        remove(ref(db, `participants/${name}`));
      }
    }

    function renameParticipant(oldName) {
      const newName = prompt("Neuer Name:", oldName)?.trim();
      if (!newName || newName === oldName || selections[newName]) return;
      const data = selections[oldName];
      set(ref(db, `participants/${newName}`), data);
      remove(ref(db, `participants/${oldName}`));
    }

    function renderStats() {
      const statsDiv = document.getElementById("stats");
      let html = "<strong>üìä Mini-Statistik:</strong><br><br>";
      for (const [name, entry] of Object.entries(selections)) {
        const createdAt = entry.createdAt ? new Date(entry.createdAt).toLocaleString("de-DE") : "unbekannt";
        const updatedAt = entry.updatedAt ? new Date(entry.updatedAt).toLocaleString("de-DE") : "unbekannt";
        html += `üë§ <strong>${name}</strong><br>`;
        html += `üïí Hinzugef√ºgt am: <em>${createdAt}</em><br>`;
        html += `‚úèÔ∏è Letzte √Ñnderung: <em>${updatedAt}</em><br><br>`;
      }
      statsDiv.innerHTML = html;
    }

    function renderTable(data) {
      tbody.innerHTML = "";
      const dateMap = {};
      for (const date of allDates) dateMap[date] = [];

      for (const [name, entry] of Object.entries(data)) {
        const dates = Array.isArray(entry) ? entry : entry.dates || [];
        const createdAt = entry.createdAt || null;
        const updatedAt = entry.updatedAt || null;
        selections[name] = { dates, createdAt, updatedAt };

        dates.forEach(d => dateMap[d]?.push(name));

        const row = document.createElement("tr");
        row.setAttribute("data-name", name);

        const nameCell = document.createElement("td");
        nameCell.textContent = name;
        row.appendChild(nameCell);

        for (const date of allDates) {
          const cell = document.createElement("td");
          cell.className = "cell";
          cell.setAttribute("data-name", name);
          cell.setAttribute("data-date", date);
          if (dates.includes(date)) {
            cell.classList.add("selected");
          }
          cell.setAttribute("data-tooltip", dateMap[date]?.join("\n") || "Niemand");
          cell.addEventListener("click", () => toggleCell(name, date));
          row.appendChild(cell);
        }

        const actionCell = document.createElement("td");
        actionCell.className = "actions";

        const renameBtn = document.createElement("button");
        renameBtn.textContent = "‚úèÔ∏è";
        renameBtn.addEventListener("click", () => renameParticipant(name));
        actionCell.appendChild(renameBtn);

        const deleteBtn = document.createElement("button");
        deleteBtn.textContent = "üóëÔ∏è";
        deleteBtn.addEventListener("click", () => deleteParticipant(name));
        actionCell.appendChild(deleteBtn);

        row.appendChild(actionCell);
        tbody.appendChild(row);
      }

      // Update Tooltips
      document.querySelectorAll(".cell").forEach(cell => {
        const date = cell.getAttribute("data-date");
        const names = dateMap[date] || [];
        cell.setAttribute("data-tooltip", names.join("\n") || "Niemand");
      });

      renderStats();
    }

    onValue(ref(db, "participants"), snapshot => {
      const data = snapshot.val() || {};
      renderTable(data);
    });
  </script>
</body>
</html>
