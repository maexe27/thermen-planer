<!DOCTYPE html>
<html lang="de">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Thermenplaner</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #f4f4f8;
      margin: 0;
      padding: 1rem;
      color: #333;
    }

    h1 {
      text-align: center;
      margin-bottom: 1rem;
    }

    .controls {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      max-width: 400px;
      margin: 0 auto 2rem auto;
    }

    select,
    button {
      padding: 0.5rem;
      font-size: 1rem;
      border-radius: 8px;
      border: 1px solid #ccc;
    }

    .calendar {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 0.5rem;
      max-width: 1000px;
      margin: 0 auto;
    }

    .day {
      background: white;
      border: 2px solid transparent;
      border-radius: 10px;
      padding: 0.5rem;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .day.selected {
      border: 2px solid #007bff;
      background-color: #e0f0ff;
    }

    @media (max-width: 768px) {
      .calendar {
        grid-template-columns: repeat(5, 1fr);
      }
    }
  </style>
</head>

<body>
  <h1>Thermenplaner</h1>

  <div class="controls">
    <label for="participantSelect">Teilnehmer:</label>
    <select id="participantSelect"></select>

    <button id="addParticipant">Teilnehmer hinzufügen</button>
    <button id="renameParticipant">Teilnehmer umbenennen</button>
    <button id="deleteParticipant">Teilnehmer löschen</button>
    <button id="saveSelections">Auswahl speichern</button>
  </div>

  <div class="calendar" id="calendar"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import {
      getDatabase,
      ref,
      onValue,
      set,
      remove,
    } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

    const firebaseConfig = {
      apiKey: "DEIN_API_KEY",
      authDomain: "DEIN_AUTH_DOMAIN",
      databaseURL: "DEINE_DATABASE_URL",
      projectId: "DEIN_PROJECT_ID",
      storageBucket: "DEIN_STORAGE_BUCKET",
      messagingSenderId: "DEIN_MESSAGING_SENDER_ID",
      appId: "DEINE_APP_ID"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const participantSelect = document.getElementById('participantSelect');
    const calendar = document.getElementById('calendar');
    const addBtn = document.getElementById('addParticipant');
    const renameBtn = document.getElementById('renameParticipant');
    const deleteBtn = document.getElementById('deleteParticipant');
    const saveBtn = document.getElementById('saveSelections');

    const numDays = 20;
    const startDate = new Date();
    const days = [];

    for (let i = 0; i < numDays; i++) {
      const date = new Date(startDate);
      date.setDate(startDate.getDate() + i);
      const day = document.createElement('div');
      day.className = 'day';
      day.dataset.date = date.toISOString().split('T')[0];
      day.innerHTML = `<strong>${date.toLocaleDateString('de-DE', { weekday: 'short' })}</strong><br>${date.toLocaleDateString('de-DE', { day: '2-digit', month: '2-digit' })}`;
      day.addEventListener('click', () => {
        day.classList.toggle('selected');
      });
      calendar.appendChild(day);
      days.push(day);
    }

    function loadParticipants() {
      const userRef = ref(db, 'users');
      onValue(userRef, (snapshot) => {
        participantSelect.innerHTML = '';
        const data = snapshot.val();
        if (data) {
          Object.keys(data).forEach((name) => {
            const option = document.createElement('option');
            option.value = name;
            option.textContent = name;
            participantSelect.appendChild(option);
          });
          loadSelection();
        }
      });
    }

    function loadSelection() {
      const name = participantSelect.value;
      if (!name) return;
      const selRef = ref(db, `users/${name}`);
      onValue(selRef, (snapshot) => {
        const selected = snapshot.val() || {};
        days.forEach(day => {
          day.classList.toggle('selected', !!selected[day.dataset.date]);
        });
      }, { onlyOnce: true });
    }

    function saveSelections() {
      const name = participantSelect.value;
      if (!name) return;
      const selectedDates = {};
      days.forEach(day => {
        if (day.classList.contains('selected')) {
          selectedDates[day.dataset.date] = true;
        }
      });
      set(ref(db, `users/${name}`), selectedDates);
    }

    function addParticipant() {
      const name = prompt('Neuer Teilnehmername:');
      if (!name) return;
      set(ref(db, `users/${name}`), {});
      participantSelect.value = name;
    }

    function renameParticipant() {
      const oldName = participantSelect.value;
      if (!oldName) return;
      const newName = prompt('Neuer Name für Teilnehmer:', oldName);
      if (!newName || newName === oldName) return;
      const oldRef = ref(db, `users/${oldName}`);
      const newRef = ref(db, `users/${newName}`);
      onValue(oldRef, (snapshot) => {
        const data = snapshot.val();
        set(newRef, data || {}).then(() => {
          remove(oldRef);
          participantSelect.value = newName;
        });
      }, { onlyOnce: true });
    }

    function deleteParticipant() {
      const name = participantSelect.value;
      if (!name) return;
      if (confirm(`Soll ${name} wirklich gelöscht werden?`)) {
        remove(ref(db, `users/${name}`));
        participantSelect.value = '';
        days.forEach(day => day.classList.remove('selected'));
      }
    }

    participantSelect.addEventListener('change', loadSelection);
    addBtn.addEventListener('click', addParticipant);
    renameBtn.addEventListener('click', renameParticipant);
    deleteBtn.addEventListener('click', deleteParticipant);
    saveBtn.addEventListener('click', saveSelections);

    loadParticipants();
  </script>
</body>

</html>
